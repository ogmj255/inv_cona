<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Inventario - Sistema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .modern-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .modern-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand, .nav-link {
            color: #333 !important;
        }
        .btn-modern {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('admin_parroquia') }}">
                <i class="fas fa-building text-success"></i> <strong>{{ parroquia.nombre }} - Inventario</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin_parroquia') }}">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card modern-card">
                    <div class="card-header bg-transparent border-0">
                        <h5><i class="fas fa-plus text-primary"></i> Agregar Nuevo Bien</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label class="form-label">Código</label>
                                <input type="text" class="form-control" name="codigo" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nombre del Equipo</label>
                                <input type="text" class="form-control" name="nombre" placeholder="Ej: PC-Oficina-01, Laptop-Admin-02" required>
                                <small class="form-text text-muted">Nombre específico o identificador del equipo</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo de Equipo</label>
                                <select class="form-control" name="tipo" id="tipoSelect" required>
                                    <option value="">Seleccionar categoría...</option>
                                    <option value="Computadora">Computadora</option>
                                    <option value="Laptop">Laptop</option>
                                    <option value="Impresora">Impresora</option>
                                    <option value="Monitor">Monitor</option>
                                    <option value="Proyector">Proyector</option>
                                    <option value="Otro">Otro</option>
                                </select>
                                <small class="form-text text-muted">Categoría general del equipo</small>
                            </div>
                            <div class="mb-3" id="otroTipoDiv" style="display:none;">
                                <label class="form-label">Especificar tipo</label>
                                <input type="text" class="form-control" name="otro_tipo" placeholder="Escriba el tipo de equipo">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Marca</label>
                                <input type="text" class="form-control" name="marca" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Modelo</label>
                                <input type="text" class="form-control" name="modelo" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="text" class="form-control" name="color" placeholder="Ej: Negro, Blanco, Gris">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estado</label>
                                <select class="form-control" name="estado_equipo" required>
                                    <option value="En funcionamiento">En funcionamiento</option>
                                    <option value="Dar mantenimiento">Dar mantenimiento</option>
                                    <option value="Dar de baja">Dar de baja</option>
                                    <option value="En reparación">En reparación</option>
                                    <option value="Nuevo">Nuevo</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Fotografía del equipo</label>
                                <input type="file" class="form-control" name="imagen" accept="image/*">
                                <small class="form-text text-muted">Formatos permitidos: JPG, PNG, GIF (máx. 5MB)</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripción</label>
                                <textarea class="form-control" name="descripcion" rows="3" placeholder="Detalles adicionales del equipo"></textarea>
                            </div>
                            <button type="submit" name="add_bien" class="btn btn-primary btn-modern">
                                <i class="fas fa-save"></i> Agregar Bien
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card modern-card">
                    <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list text-success"></i> Inventario de {{ parroquia.nombre }}</h5>
                        <div>
                            <a href="{{ url_for('exportar_excel', tipo='inventario') }}" class="btn btn-sm btn-success">
                                <i class="fas fa-file-excel"></i> Excel
                            </a>
                            <a href="{{ url_for('generar_reporte_pdf', tipo='inventario') }}" class="btn btn-sm btn-danger">
                                <i class="fas fa-file-pdf"></i> PDF
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filtros de búsqueda -->
                        <form method="GET" class="mb-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" name="search" placeholder="Buscar por código, nombre, marca..." value="{{ search }}">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" name="estado">
                                        <option value="">Todos los estados</option>
                                        <option value="disponible" {{ 'selected' if estado_filter == 'disponible' }}>Disponible</option>
                                        <option value="asignado" {{ 'selected' if estado_filter == 'asignado' }}>Asignado</option>
                                        <option value="en_mantenimiento" {{ 'selected' if estado_filter == 'en_mantenimiento' }}>En Mantenimiento</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" name="tipo">
                                        <option value="">Todos los tipos</option>
                                        {% for tipo in tipos_disponibles %}
                                        <option value="{{ tipo }}" {{ 'selected' if tipo_filter == tipo }}>{{ tipo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Buscar
                                    </button>
                                </div>
                            </div>
                        </form>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Foto</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Tipo</th>
                                        <th>Marca/Modelo</th>
                                        <th>Color</th>
                                        <th>Estado Equipo</th>
                                        <th>Estado Asignación</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bien in bienes %}
                                    <tr>
                                        <td>
                                            {% if bien.imagen %}
                                                <div class="image-container" style="position: relative; width: 50px; height: 50px;">
                                                    <img src="data:image/jpeg;base64,{{ bien.imagen }}" alt="{{ bien.nombre }}" class="hover-image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; cursor: pointer; transition: transform 0.3s ease;" onclick="showImageModal('data:image/jpeg;base64,{{ bien.imagen }}', '{{ bien.nombre }}')" title="Click para ampliar">
                                                    <div class="image-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); border-radius: 5px; display: none; align-items: center; justify-content: center; cursor: pointer;">
                                                        <i class="fas fa-search-plus text-white"></i>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div style="width: 50px; height: 50px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>{{ bien.codigo }}</td>
                                        <td>{{ bien.nombre }}</td>
                                        <td>{{ bien.tipo }}</td>
                                        <td>{{ bien.marca }} {{ bien.modelo }}</td>
                                        <td>{{ bien.color or 'N/A' }}</td>
                                        <td>
                                            {% if bien.estado_equipo == 'En funcionamiento' %}
                                                <span class="badge bg-success">En funcionamiento</span>
                                            {% elif bien.estado_equipo == 'Dar mantenimiento' %}
                                                <span class="badge bg-warning">Dar mantenimiento</span>
                                            {% elif bien.estado_equipo == 'Dar de baja' %}
                                                <span class="badge bg-danger">Dar de baja</span>
                                            {% elif bien.estado_equipo == 'En reparación' %}
                                                <span class="badge bg-info">En reparación</span>
                                            {% else %}
                                                <span class="badge bg-primary">{{ bien.estado_equipo or 'N/A' }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if bien.estado == 'disponible' %}
                                                <span class="badge bg-success">Disponible</span>
                                            {% elif bien.estado == 'asignado' %}
                                                <span class="badge bg-warning">Asignado</span>
                                            {% elif bien.estado == 'en_mantenimiento' %}
                                                <span class="badge bg-info">En Mantenimiento</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ bien.estado }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ bien.created_at.strftime('%d/%m/%Y') if bien.created_at else 'N/A' }}</td>
                                        <td>
                                            <a href="{{ url_for('generar_qr', bien_id=bien._id) }}" class="btn btn-sm btn-info" title="Generar QR">
                                                <i class="fas fa-qrcode"></i>
                                            </a>
                                            <button class="btn btn-sm btn-warning" onclick="editBien('{{ bien._id }}', '{{ bien.codigo }}', '{{ bien.nombre }}', '{{ bien.tipo }}', '{{ bien.marca }}', '{{ bien.modelo }}', '{{ bien.descripcion or "" }}')" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form method="POST" style="display: inline;" onsubmit="return confirm('¿Está seguro de eliminar este bien?')">
                                                <input type="hidden" name="bien_id" value="{{ bien._id }}">
                                                <button type="submit" name="delete_bien" class="btn btn-sm btn-danger" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <!-- Modal Editar Bien -->
    <div class="modal fade" id="editBienModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Bien</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="bien_id" id="edit_bien_id">
                        <div class="mb-3">
                            <label class="form-label">Código</label>
                            <input type="text" class="form-control" name="edit_codigo" id="edit_bien_codigo" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" name="edit_nombre" id="edit_bien_nombre" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            <input type="text" class="form-control" name="edit_tipo" id="edit_bien_tipo" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Marca</label>
                            <input type="text" class="form-control" name="edit_marca" id="edit_bien_marca" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Modelo</label>
                            <input type="text" class="form-control" name="edit_modelo" id="edit_bien_modelo" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" name="edit_descripcion" id="edit_bien_descripcion" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" name="edit_bien" class="btn btn-warning">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Ver Imagen -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalTitle">Imagen del Bien</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="" style="max-width: 100%; height: auto;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function editBien(id, codigo, nombre, tipo, marca, modelo, descripcion = '') {
            document.getElementById('edit_bien_id').value = id;
            document.getElementById('edit_bien_codigo').value = codigo;
            document.getElementById('edit_bien_nombre').value = nombre;
            document.getElementById('edit_bien_tipo').value = tipo;
            document.getElementById('edit_bien_marca').value = marca;
            document.getElementById('edit_bien_modelo').value = modelo;
            document.getElementById('edit_bien_descripcion').value = descripcion;
            new bootstrap.Modal(document.getElementById('editBienModal')).show();
        }

        function showImageModal(src, title) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModalTitle').textContent = title;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }

        // Image hover effects
        document.addEventListener('DOMContentLoaded', function() {
            const imageContainers = document.querySelectorAll('.image-container');
            imageContainers.forEach(container => {
                const img = container.querySelector('.hover-image');
                const overlay = container.querySelector('.image-overlay');
                
                container.addEventListener('mouseenter', function() {
                    if (img) img.style.transform = 'scale(1.2)';
                    if (overlay) overlay.style.display = 'flex';
                });
                
                container.addEventListener('mouseleave', function() {
                    if (img) img.style.transform = 'scale(1)';
                    if (overlay) overlay.style.display = 'none';
                });
                
                // Agregar click event para mostrar modal
                container.addEventListener('click', function() {
                    const imgSrc = img ? img.src : '';
                    const imgTitle = img ? img.alt : 'Imagen';
                    if (imgSrc) {
                        showImageModal(imgSrc, imgTitle);
                    }
                });
            });
        });

        // Show Flask flash messages as toasts
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    showToast('{{ message }}', '{{ category }}');
                {% endfor %}
            {% endif %}
        {% endwith %}
    </script>
</body>
</html>
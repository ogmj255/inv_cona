<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Inventario - Sistema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='admin.css') }}" rel="stylesheet">
</head>
<body class="inventario-body">
    <nav class="navbar navbar-expand-lg navbar-light inventario-navbar">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('admin_parroquia') }}">
                <i class="fas fa-building text-success"></i> <strong>{{ parroquia.nombre }} - Inventario</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin_parroquia') }}">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card modern-card">
                    <div class="card-header bg-transparent border-0">
                        <h5><i class="fas fa-plus text-primary"></i> Agregar Nuevo Bien</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('gestionar_inventario') }}" enctype="multipart/form-data" id="addBienForm">
                            <div class="mb-3">
                                <label class="form-label">C√≥digo *</label>
                                <input type="text" class="form-control" name="codigo" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nombre del Equipo *</label>
                                <input type="text" class="form-control" name="nombre" placeholder="Ej: PC-Oficina-01, Laptop-Admin-02" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo de Equipo *</label>
                                <select class="form-control" name="tipo" id="tipoSelect" required>
                                    <option value="">Seleccionar categor√≠a...</option>
                                    <option value="Computadora">Computadora</option>
                                    <option value="Laptop">Laptop</option>
                                    <option value="Impresora">Impresora</option>
                                    <option value="Monitor">Monitor</option>
                                    <option value="Proyector">Proyector</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="mb-3" id="otroTipoDiv" style="display:none;">
                                <label class="form-label">Especificar tipo</label>
                                <input type="text" class="form-control" name="otro_tipo" placeholder="Escriba el tipo de equipo">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Marca *</label>
                                <input type="text" class="form-control" name="marca" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Modelo *</label>
                                <input type="text" class="form-control" name="modelo" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="text" class="form-control" name="color" placeholder="Ej: Negro, Blanco, Gris">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estado del Equipo</label>
                                <select class="form-control" name="estado_equipo" id="estadoEquipoSelect">
                                    <option value="En funcionamiento">En funcionamiento</option>
                                    <option value="Dar mantenimiento">Dar mantenimiento</option>
                                    <option value="Dar de baja">Dar de baja</option>
                                    <option value="En reparaci√≥n">En reparaci√≥n</option>
                                    <option value="Nuevo">Nuevo</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Fotograf√≠a del equipo</label>
                                <input type="file" class="form-control" name="imagen" accept="image/*">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripci√≥n</label>
                                <textarea class="form-control" name="descripcion" rows="3" placeholder="Detalles adicionales del equipo"></textarea>
                            </div>
                            <button type="submit" name="add_bien" class="btn btn-primary btn-modern">
                                <i class="fas fa-save"></i> Agregar Bien
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card modern-card">
                    <div class="card-header bg-transparent border-0">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-list text-success"></i> Inventario de {{ parroquia.nombre }} 
                                <span class="badge bg-primary">{{ bienes|length }} items</span>
                            </h5>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('cargar_inventario_masivo') }}" class="btn btn-sm btn-warning" title="Cargar m√∫ltiples bienes desde Excel">
                                    <i class="fas fa-cloud-upload-alt"></i> Carga Masiva
                                </a>
                                <a href="{{ url_for('exportar_excel', tipo='inventario') }}" class="btn btn-sm btn-success" title="Exportar a Excel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </a>
                                <a href="{{ url_for('generar_reporte_pdf', tipo='inventario') }}" class="btn btn-sm btn-danger" title="Generar reporte PDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </a>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar por c√≥digo, nombre, tipo...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterTipo">
                                    <option value="">üìä Todos los tipos</option>
                                    <option value="Computadora">üíª Computadora</option>
                                    <option value="Laptop">üíª Laptop</option>
                                    <option value="Impresora">üñ®Ô∏è Impresora</option>
                                    <option value="Monitor">üñ•Ô∏è Monitor</option>
                                    <option value="Proyector">üìΩÔ∏è Proyector</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterEstado">
                                    <option value="">üìä Todos los estados</option>
                                    <option value="disponible">‚úÖ Disponible</option>
                                    <option value="asignado">üîÑ Asignado</option>
                                    <option value="en_mantenimiento">üîß En Mantenimiento</option>
                                    <option value="da√±ado">‚ùå Da√±ado</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()" title="Limpiar filtros">
                                    <i class="fas fa-eraser"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="inventoryTable">
                                <thead>
                                    <tr>
                                        <th>Foto</th>
                                        <th>C√≥digo</th>
                                        <th>Nombre</th>
                                        <th>Tipo</th>
                                        <th>Marca/Modelo</th>
                                        <th>Color</th>
                                        <th>Estado Equipo</th>
                                        <th>Estado Asignaci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody">
                                    {% for bien in bienes %}
                                    <tr>
                                        <td>
                                            {% if bien.imagen %}
                                                <div class="image-container" style="position: relative; width: 50px; height: 50px;">
                                                    <img src="data:image/jpeg;base64,{{ bien.imagen }}" alt="{{ bien.nombre }}" class="hover-image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; cursor: pointer; transition: transform 0.3s ease;" onclick="showImageModal('data:image/jpeg;base64,{{ bien.imagen }}', '{{ bien.nombre }}')" title="Click para ampliar">
                                                    <div class="image-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); border-radius: 5px; display: none; align-items: center; justify-content: center; cursor: pointer;">
                                                        <i class="fas fa-search-plus text-white"></i>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div style="width: 50px; height: 50px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>{{ bien.codigo }}</td>
                                        <td>{{ bien.nombre }}</td>
                                        <td>{{ bien.tipo }}</td>
                                        <td>{{ bien.marca }} {{ bien.modelo }}</td>
                                        <td>{{ bien.color or 'N/A' }}</td>
                                        <td>
                                            {% if bien.estado_equipo == 'En funcionamiento' %}
                                                <span class="badge bg-success">En funcionamiento</span>
                                            {% elif bien.estado_equipo == 'Dar mantenimiento' %}
                                                <span class="badge bg-warning">Dar mantenimiento</span>
                                            {% elif bien.estado_equipo == 'Dar de baja' %}
                                                <span class="badge bg-danger">Dar de baja</span>
                                            {% elif bien.estado_equipo == 'En reparaci√≥n' %}
                                                <span class="badge bg-info">En reparaci√≥n</span>
                                            {% else %}
                                                <span class="badge bg-primary">{{ bien.estado_equipo or 'N/A' }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if bien.estado == 'disponible' %}
                                                <span class="badge bg-success">Disponible</span>
                                            {% elif bien.estado == 'asignado' %}
                                                <span class="badge bg-warning">Asignado</span>
                                            {% elif bien.estado == 'en_mantenimiento' %}
                                                <span class="badge bg-info">En Mantenimiento</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ bien.estado }}</span>
                                            {% endif %}
                                        </td>

                                        <td>
                                            <div class="btn-group" role="group">
                                                <!-- Estado Dropdown -->
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Cambiar Estado">
                                                        <i class="fas fa-exchange-alt"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item" href="#" onclick="cambiarEstado('{{ bien._id }}', 'disponible')">
                                                            <i class="fas fa-check-circle text-success me-2"></i>Disponible
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="cambiarEstado('{{ bien._id }}', 'asignado')">
                                                            <i class="fas fa-hand-holding text-warning me-2"></i>Asignado
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="cambiarEstado('{{ bien._id }}', 'en_mantenimiento')">
                                                            <i class="fas fa-tools text-info me-2"></i>En Mantenimiento
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="cambiarEstado('{{ bien._id }}', 'da√±ado')">
                                                            <i class="fas fa-times-circle text-danger me-2"></i>Da√±ado
                                                        </a></li>
                                                    </ul>
                                                </div>
                                                
                                                <!-- QR Button -->
                                                <a href="{{ url_for('generar_qr', bien_id=bien._id) }}" class="btn btn-sm btn-outline-info" title="Generar C√≥digo QR">
                                                    <i class="fas fa-qrcode"></i>
                                                </a>
                                                
                                                <!-- Edit Button -->
                                                <button class="btn btn-sm btn-outline-warning" onclick="editBien('{{ bien._id }}', '{{ bien.codigo }}', '{{ bien.nombre }}', '{{ bien.tipo }}', '{{ bien.marca }}', '{{ bien.modelo }}', '{{ bien.descripcion or "" }}')" title="Editar Bien">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                
                                                <!-- Delete Button -->
                                                <form method="POST" style="display: inline;" onsubmit="return confirm('¬øEst√° seguro de eliminar este bien?\n\nEsta acci√≥n no se puede deshacer.')">
                                                    <input type="hidden" name="bien_id" value="{{ bien._id }}">
                                                    <button type="submit" name="delete_bien" class="btn btn-sm btn-outline-danger" title="Eliminar Bien">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <!-- Modal Editar Bien -->
    <div class="modal fade" id="editBienModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Bien</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="bien_id" id="edit_bien_id">
                        <div class="mb-3">
                            <label class="form-label">C√≥digo</label>
                            <input type="text" class="form-control" name="edit_codigo" id="edit_bien_codigo" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" name="edit_nombre" id="edit_bien_nombre" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            <input type="text" class="form-control" name="edit_tipo" id="edit_bien_tipo" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Marca</label>
                            <input type="text" class="form-control" name="edit_marca" id="edit_bien_marca" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Modelo</label>
                            <input type="text" class="form-control" name="edit_modelo" id="edit_bien_modelo" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" name="edit_descripcion" id="edit_bien_descripcion" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" name="edit_bien" class="btn btn-warning">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Ver Imagen -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalTitle">Imagen del Bien</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="" style="max-width: 100%; height: auto;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                window.flashMessages = [
                    {% for category, message in messages %}
                        {message: '{{ message }}', category: '{{ category }}'}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ];
            {% endif %}
        {% endwith %}
        
        // Initialize tipo select handler
        document.addEventListener('DOMContentLoaded', function() {
            const tipoSelect = document.getElementById('tipoSelect');
            const otroTipoDiv = document.getElementById('otroTipoDiv');
            const form = document.getElementById('addBienForm');
            
            if (tipoSelect && otroTipoDiv) {
                tipoSelect.addEventListener('change', function() {
                    if (this.value === 'Otro') {
                        otroTipoDiv.style.display = 'block';
                    } else {
                        otroTipoDiv.style.display = 'none';
                    }
                });
            }
            
            // Debug form submission
            if (form) {
                form.addEventListener('submit', function(e) {
                    console.log('Form being submitted');
                    console.log('Form action:', form.action);
                    console.log('Form method:', form.method);
                    
                    // Check required fields
                    const codigo = document.querySelector('input[name="codigo"]').value;
                    const nombre = document.querySelector('input[name="nombre"]').value;
                    const tipo = document.querySelector('select[name="tipo"]').value;
                    const marca = document.querySelector('input[name="marca"]').value;
                    const modelo = document.querySelector('input[name="modelo"]').value;
                    
                    console.log('Form data:', {codigo, nombre, tipo, marca, modelo});
                    
                    if (!codigo || !nombre || !tipo || !marca || !modelo) {
                        console.log('Missing required fields');
                        alert('Por favor complete todos los campos obligatorios');
                        e.preventDefault();
                        return false;
                    }
                });
            }
            
            // Search and filter functionality
            const searchInput = document.getElementById('searchInput');
            const filterTipo = document.getElementById('filterTipo');
            const filterEstado = document.getElementById('filterEstado');
            
            function filterTable() {
                const searchTerm = searchInput.value.toLowerCase();
                const tipoFilter = filterTipo.value;
                const estadoFilter = filterEstado.value;
                const rows = document.querySelectorAll('#inventoryTableBody tr');
                
                rows.forEach(row => {
                    const codigo = row.cells[1].textContent.toLowerCase();
                    const nombre = row.cells[2].textContent.toLowerCase();
                    const tipo = row.cells[3].textContent;
                    const estado = row.cells[7].textContent.toLowerCase();
                    
                    const matchesSearch = codigo.includes(searchTerm) || nombre.includes(searchTerm) || tipo.toLowerCase().includes(searchTerm);
                    const matchesTipo = !tipoFilter || tipo === tipoFilter;
                    const matchesEstado = !estadoFilter || estado.includes(estadoFilter);
                    
                    row.style.display = matchesSearch && matchesTipo && matchesEstado ? '' : 'none';
                });
            }
            
            if (searchInput) searchInput.addEventListener('input', filterTable);
            if (filterTipo) filterTipo.addEventListener('change', filterTable);
            if (filterEstado) filterEstado.addEventListener('change', filterTable);
        });
        
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterEstado').value = '';
            document.querySelectorAll('#inventoryTableBody tr').forEach(row => {
                row.style.display = '';
            });
        }
        
        function showImageModal(src, title) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModalTitle').textContent = title;
            new bootstrap.Modal(document.getElementById('imageModal')).show();
        }
        
        function cambiarEstado(bienId, nuevoEstado) {
            if (confirm(`¬øEst√° seguro de cambiar el estado a: ${nuevoEstado.replace('_', ' ')}?`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("cambiar_estado_bien") }}';
                form.innerHTML = `
                    <input type="hidden" name="bien_id" value="${bienId}">
                    <input type="hidden" name="nuevo_estado" value="${nuevoEstado}">
                `;
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mantenimiento - Sistema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light super-navbar">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('super_admin') }}">
                <i class="fas fa-tools text-danger"></i> <strong>Sistema - Mantenimiento</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('super_admin') }}">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>¡ZONA DE PELIGRO!</strong> Las acciones en esta sección pueden eliminar datos permanentemente. Procede con extrema precaución.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <h2><i class="fas fa-wrench"></i> Mantenimiento del Sistema</h2>
                <p class="text-muted">Herramientas para limpiar y mantener la base de datos del sistema</p>
            </div>
        </div>

        <!-- Estadísticas de Mantenimiento -->
        <div class="row mt-4">
            <div class="col-md-2 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="icon-wrapper" style="--icon-color-1: #17a2b8; --icon-color-2: #20c997;">
                            <i class="fas fa-file-alt fa-2x text-white"></i>
                        </div>
                        <h3 class="fw-bold text-info">{{ stats.total_logs }}</h3>
                        <p class="text-muted mb-0">Logs Auditoría</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="icon-wrapper" style="--icon-color-1: #ffc107; --icon-color-2: #fd7e14;">
                            <i class="fas fa-bell fa-2x text-white"></i>
                        </div>
                        <h3 class="fw-bold text-warning">{{ stats.total_notificaciones }}</h3>
                        <p class="text-muted mb-0">Notificaciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="icon-wrapper" style="--icon-color-1: #6c757d; --icon-color-2: #495057;">
                            <i class="fas fa-undo fa-2x text-white"></i>
                        </div>
                        <h3 class="fw-bold text-secondary">{{ stats.asignaciones_devueltas }}</h3>
                        <p class="text-muted mb-0">Asign. Devueltas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="icon-wrapper" style="--icon-color-1: #343a40; --icon-color-2: #212529;">
                            <i class="fas fa-clock fa-2x text-white"></i>
                        </div>
                        <h3 class="fw-bold text-dark">{{ stats.logs_antiguos }}</h3>
                        <p class="text-muted mb-0">Logs Antiguos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="icon-wrapper" style="--icon-color-1: #dc3545; --icon-color-2: #c82333;">
                            <i class="fas fa-users fa-2x text-white"></i>
                        </div>
                        <h3 class="fw-bold text-danger">{{ stats.total_usuarios }}</h3>
                        <p class="text-muted mb-0">Total Usuarios</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <div class="card stats-card text-center">
                    <div class="card-body">
                        <div class="icon-wrapper" style="--icon-color-1: #28a745; --icon-color-2: #20c997;">
                            <i class="fas fa-map-marker-alt fa-2x text-white"></i>
                        </div>
                        <h3 class="fw-bold text-success">{{ stats.total_parroquias }}</h3>
                        <p class="text-muted mb-0">Parroquias</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones de Mantenimiento -->
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card modern-card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-broom"></i> Limpieza Selectiva</h5>
                    </div>
                    <div class="card-body">
                        <!-- Limpiar Logs -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-file-alt text-info me-2"></i>
                                <h6 class="mb-0">Logs de Auditoría</h6>
                            </div>
                            <p class="small text-muted">{{ stats.total_logs }} registros</p>
                            <form method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="accion" value="limpiar_logs">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" name="confirmacion" placeholder="CONFIRMAR LIMPIEZA" required>
                                </div>
                                <button type="button" class="btn btn-warning btn-sm w-100" onclick="showConfirmModal('limpiar_logs', 'Logs de Auditoría', '{{ stats.total_logs }}')">
                                    <i class="fas fa-trash"></i> Limpiar Logs
                                </button>
                            </form>
                        </div>

                        <!-- Limpiar Notificaciones -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-bell text-warning me-2"></i>
                                <h6 class="mb-0">Notificaciones</h6>
                            </div>
                            <p class="small text-muted">{{ stats.total_notificaciones }} registros</p>
                            <form method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="accion" value="limpiar_notificaciones">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" name="confirmacion" placeholder="CONFIRMAR LIMPIEZA" required>
                                </div>
                                <button type="button" class="btn btn-warning btn-sm w-100" onclick="showConfirmModal('limpiar_notificaciones', 'Notificaciones', '{{ stats.total_notificaciones }}')">
                                    <i class="fas fa-trash"></i> Limpiar Notificaciones
                                </button>
                            </form>
                        </div>

                        <!-- Limpiar Asignaciones -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-undo text-secondary me-2"></i>
                                <h6 class="mb-0">Asignaciones Devueltas</h6>
                            </div>
                            <p class="small text-muted">{{ stats.asignaciones_devueltas }} registros</p>
                            <form method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="accion" value="limpiar_asignaciones_devueltas">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" name="confirmacion" placeholder="CONFIRMAR LIMPIEZA" required>
                                </div>
                                <button type="button" class="btn btn-warning btn-sm w-100" onclick="showConfirmModal('limpiar_asignaciones_devueltas', 'Asignaciones Devueltas', '{{ stats.asignaciones_devueltas }}')">
                                    <i class="fas fa-trash"></i> Limpiar Asignaciones
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card modern-card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-users-slash"></i> Limpiar Usuarios</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>¡PELIGRO!</strong> Eliminará TODOS los usuarios del sistema.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-users text-danger me-2"></i>
                                <h6 class="mb-0">Total Usuarios</h6>
                            </div>
                            <p class="small text-muted">{{ stats.total_usuarios }} usuarios registrados</p>
                        </div>
                        
                        <div class="mb-3">
                            <p class="small text-muted">
                                <strong>Se eliminarán:</strong><br>
                                • Administradores de parroquia<br>
                                • Técnicos<br>
                                • Otros super administradores<br>
                                <br>
                                <strong>Se conservarán:</strong><br>
                                • Usuario admin principal<br>
                                • Parroquias registradas
                            </p>
                        </div>
                        
                        <form method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="accion" value="limpiar_usuarios">
                            <div class="mb-3">
                                <input type="text" class="form-control" name="confirmacion" placeholder="CONFIRMAR LIMPIEZA" required>
                            </div>
                            <button type="button" class="btn btn-danger w-100" onclick="showConfirmModal('limpiar_usuarios', 'TODOS los Usuarios', '{{ stats.total_usuarios }}')">
                                <i class="fas fa-user-times"></i> ELIMINAR USUARIOS
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card modern-card border-dark">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-nuclear"></i> Reset Total</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-dark alert-dismissible fade show">
                            <i class="fas fa-radiation"></i>
                            <strong>¡MÁXIMO PELIGRO!</strong> Eliminará TODO excepto parroquias.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        
                        <div class="mb-3">
                            <p class="small text-muted">
                                <strong>Se eliminarán:</strong><br>
                                • Todos los bienes<br>
                                • Todas las asignaciones<br>
                                • Todos los logs<br>
                                • Todas las notificaciones<br>
                                • Todos los usuarios (excepto admin)<br>
                                <br>
                                <strong>Solo se conservan:</strong><br>
                                • Usuario admin principal<br>
                                • Parroquias registradas
                            </p>
                        </div>
                        
                        <form method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="accion" value="reset_completo">
                            <div class="mb-3">
                                <input type="text" class="form-control" name="confirmacion" placeholder="CONFIRMAR LIMPIEZA" required>
                            </div>
                            <button type="button" class="btn btn-dark w-100" onclick="showConfirmModal('reset_completo', 'RESET TOTAL DEL SISTEMA', 'TODO')">
                                <i class="fas fa-nuclear"></i> RESET TOTAL
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Acción Peligrosa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-radiation"></i> <strong>¡ADVERTENCIA!</strong> Esta acción no se puede deshacer.
                    </div>
                    <p id="confirmMessage"></p>
                    <div class="mb-3">
                        <label class="form-label">Para confirmar, escriba exactamente: <strong>CONFIRMAR LIMPIEZA</strong></label>
                        <input type="text" class="form-control" id="confirmInput" placeholder="CONFIRMAR LIMPIEZA">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmButton" onclick="executeAction()">Confirmar Acción</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAction = '';
        
        function showConfirmModal(action, itemName, count) {
            currentAction = action;
            const messages = {
                'limpiar_logs': `🗂️ Se eliminarán ${count} logs de auditoría`,
                'limpiar_notificaciones': `🔔 Se eliminarán ${count} notificaciones`,
                'limpiar_asignaciones_devueltas': `↩️ Se eliminarán ${count} asignaciones devueltas`,
                'limpiar_usuarios': `👥 Se eliminarán ${count} usuarios (admin preservado)`,
                'reset_completo': `💀 Se eliminará TODO excepto parroquias y admin`
            };
            
            document.getElementById('confirmMessage').innerHTML = messages[action] || `Se eliminará: ${itemName}`;
            document.getElementById('confirmInput').value = '';
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }
        
        function executeAction() {
            const input = document.getElementById('confirmInput').value;
            if (input !== 'CONFIRMAR LIMPIEZA') {
                alert('❌ Debe escribir exactamente: CONFIRMAR LIMPIEZA');
                return;
            }
            
            const form = document.createElement('form');
            form.method = 'POST';
            const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';
            form.innerHTML = `
                <input type="hidden" name="csrf_token" value="${csrfToken}">
                <input type="hidden" name="accion" value="${currentAction}">
                <input type="hidden" name="confirmacion" value="CONFIRMAR LIMPIEZA">
            `;
            document.body.appendChild(form);
            form.submit();
        }
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>